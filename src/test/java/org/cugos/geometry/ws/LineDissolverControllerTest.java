package org.cugos.geometry.ws;

import io.micronaut.http.HttpRequest;
import io.micronaut.http.MediaType;
import org.junit.Test;

import java.net.URLEncoder;

import static org.junit.Assert.assertEquals;

public class LineDissolverControllerTest extends AbstractControllerTest  {

    private static final String inputGeometry = "LINESTRING (1143429.5177049513 646812.5700195221, 1148620.8088546866 646812.5700195221, " +
            "1149092.7444137533 643980.956665121, 1150980.4866500208 640677.4077516531, 1156171.777799756 640677.4077516531, " +
            "1156171.777799756 643037.0855469874, 1156171.777799756 648700.3122557894, 1161835.004508558 658610.958996193, " +
            "1163250.8111857586 652003.8611692573, 1163250.8111857586 646812.5700195221, 1162778.8756266916 639733.5366335195, " +
            "1160891.1333904243 637373.8588381852, 1154755.9711225554 635486.1166019179, 1146733.0666184193 633598.3743656506, " +
            "1144845.3243821517 637373.8588381852, 1141069.839909617 642093.2144288537, 1138710.1621142828 650116.1189329899, " +
            "1136350.4843189488 649644.1833739231, 1134934.6776417482 647756.4411376558, 1134934.6776417482 645868.6989013883, " +
            "1136350.4843189488 639261.6010744526, 1139654.0332324165 637373.8588381852)";

    private static final String expectedOutputGeometry = "LINESTRING (1139654.0332324165 637373.8588381852, " +
            "1136350.4843189488 639261.6010744526, 1134934.6776417482 645868.6989013883, 1134934.6776417482 647756.4411376558, " +
            "1136350.4843189488 649644.1833739231, 1138710.1621142828 650116.1189329899, 1141069.839909617 642093.2144288537, " +
            "1144845.3243821517 637373.8588381852, 1146733.0666184193 633598.3743656506, 1154755.9711225554 635486.1166019179, " +
            "1160891.1333904243 637373.8588381852, 1162778.8756266916 639733.5366335195, 1163250.8111857586 646812.5700195221, " +
            "1163250.8111857586 652003.8611692573, 1161835.004508558 658610.958996193, 1156171.777799756 648700.3122557894, " +
            "1156171.777799756 643037.0855469874, 1156171.777799756 640677.4077516531, 1150980.4866500208 640677.4077516531, " +
            "1149092.7444137533 643980.956665121, 1148620.8088546866 646812.5700195221, 1143429.5177049513 646812.5700195221)";

    @Test
    public void get() throws Exception {
        HttpRequest request = HttpRequest.GET("/lineDissolve/wkt/wkt?geom=" + URLEncoder.encode(inputGeometry, "UTF-8"));
        String geometry = client.toBlocking().retrieve(request);
        assertEquals(expectedOutputGeometry, geometry);
    }

    @Test
    public void post() throws Exception {
        HttpRequest request = HttpRequest.POST("/lineDissolve/wkt/wkt", inputGeometry).contentType(MediaType.TEXT_PLAIN_TYPE);
        String geometry = client.toBlocking().retrieve(request);
        assertEquals(expectedOutputGeometry, geometry);
    }

}
